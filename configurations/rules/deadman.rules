import org.openhab.core.library.types.*
import org.openhab.core.persistence.*
import org.openhab.model.script.actions.*

import java.util.List
import java.util.ArrayList

// constants 
val dmt = 300   // 5 hours
val email_freq = 120 * 10 
val doorbell_email_freq = 1 * 4 

val ticks_since_email = 100000
val ticks_since_doorbell_email = 100000

val FF_LR_temp = 0
val FF_LR_last_change = 0

var NowString = ""

/********************/
/* Send email test  */
/********************/

rule "send email test"
when
    Item email_test changed to 1
then
	logInfo("FILE", "*** sending test email ***")
    sendMail("jfstepha@gmail.com","Test","This is a test message")
end


/********************/
/* Deadman          */
/********************/

rule "Deadman cron"
when Time cron "15 * * * * ?" then
    ticks_since_email += 1

    NowString = now.getMonthOfYear + "/" + now.getDayOfMonth + "/" + now.getYear + " " + 
        now.getHourOfDay + ":" + String::format( "%02d" , now.getMinuteOfHour) + ":" + String::format("%02d",now.getSecondOfMinute)
	logInfo("FILE", "** deadman cron " + NowString + " ***")
	logInfo("FILE", "* ticks since email: " + ticks_since_email )
	logInfo("FILE", "* LR Thermo:" + Temperature_FF_Living_Thermo.state + " Prev: " + FF_LR_temp + " last change: " + FF_LR_last_change )
	
    if Temperature_FF_Living_Thermo.state != FF_LR_temp {
	    // logInfo("FILE", "* LR Thermo changed")
	    FF_LR_temp = Temperature_FF_Living_Thermo.state
	    FF_LR_last_change = 0
    } else {
    	FF_LR_last_change += 1
    	// logInfo("FILE", "* LR Thermo unchanged for " + FF_LR_last_change + " ticks")
    }
    if (FF_LR_last_change > dmt ) {
    	logInfo("FILE", "*** Something's stuck! ***")
    	if ticks_since_email < email_freq {
    		logInfo("FILE", "* supressing email because we sent one " + ticks_since_email + " ticks ago ***")
    	} else {
    		logInfo("FILE", "* sending email")
        	sendMail("jfstepha@gmail.com","Openhab alert: Temperature stuck!!!","**** Openhab alert: temperature stuck **** \n\n" +
        		"Some temperature is stuck!\n\n" +
    	    	"## Living Room: ## " + "\n"+
    		    "   Temp: " + Temperature_FF_Living_Thermo.state + "\n" +
    		    "   Prev:" + FF_LR_temp + "\n" +
    		    "   time since change: " + FF_LR_last_change + "\n" +
    		    "   ping time: " + Ping_LR_THERMO.state + "\n" +
    		    "\n" +
                "# other info #\n" + 
                " ticks since email:" + ticks_since_email + "\n"
    		    )
            ticks_since_email = 0
        }
    }
	
end


/********************/
/* Daily email      */
/********************/

rule "Daily email"
when 
    Time cron "0 02 09 * * ?"
then
	logInfo("FILE", "*** sending daily email ***")
    sendMail("jfstepha@gmail.com","Openhab daily email","**** This Openhab daily status email " + NowString + " **** \n\n" + 
    	  "** temperatures **\n" +
    	  "Living room temp: " + Temperature_FF_Living_Thermo.state + " setpoint: " + TempSet_FF_Living.state + "\n" +
    	  "\n** duty cycles **\n " +
    	  "First floor heat: " + Heat_FF_Duty_Cycle.state + " First floor cool:" + Cool_FF_Duty_Cycle.state +"\n" +
    	  "\n** deamons **\n" +
    	  "Living room: " + Daemon_FF_Living.state + "\n" 
    )
end

